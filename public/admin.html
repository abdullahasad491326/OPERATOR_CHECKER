<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --text-color: #e0e0e0;
      --text-muted: #b0b0b0;
      --success: #28a745;
      --success-hover: #218838;
      --danger: #dc3545;
      --danger-hover: #c82333;
      --border-color: #333333;
      --blocked-row-bg: #4a1e1e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .dashboard-container {
      width: 100%;
      max-width: 1100px;
      margin: auto;
      display: grid;
      gap: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background-color: var(--card-bg);
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .header {
      text-align: center;
      margin-bottom: 10px;
    }

    .header h1 {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .header p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* Login form */
    .login-form {
      max-width: 400px;
      margin: 10px auto 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .input-group {
      position: relative;
    }

    .input-group input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: #2c2c2c;
      color: var(--text-color);
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .input-group input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .input-group .icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1rem;
    }

    .input-group input::placeholder {
      color: var(--text-muted);
    }

    .login-form button {
      background-color: var(--primary-color);
      color: #fff;
      font-weight: 700;
      padding: 14px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .login-form button:hover:not(:disabled) {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
    }

    .login-form button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .login-message {
      margin-top: 10px;
      font-size: 0.9rem;
      text-align: center;
      color: var(--danger);
      min-height: 1.2em;
    }

    /* Admin section hidden initially */
    #adminSection.hidden {
      display: none;
    }

  </style>
  <!-- We'll add JS scripts in parts 2-4 -->
</head>
<body>
  <main class="dashboard-container">

    <!-- Login Section -->
    <section id="loginSection">
      <header class="card header">
        <h1>Admin Login</h1>
        <p>Access the SMS Service Panel</p>
      </header>
      <div class="card">
        <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
          <div class="input-group">
            <span class="icon"><i class="fas fa-user"></i></span>
            <input type="text" id="username" placeholder="Username" required autocomplete="username" />
          </div>
          <div class="input-group">
            <span class="icon"><i class="fas fa-lock"></i></span>
            <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />
          </div>
          <button type="submit" id="loginButton">Login</button>
          <p id="loginMessage" class="login-message"></p>
        </form>
      </div>
    </section>

    <!-- Admin Section -->
    <section id="adminSection" class="hidden">
      <header class="card header">
        <h1>Admin Dashboard</h1>
        <p>Manage SMS Service and View Logs</p>
      </header>

      <div class="card admin-controls" style="display:flex; justify-content: space-between; align-items:center; flex-wrap: wrap; gap: 15px;">
        <div>
          <h2 style="margin-bottom:8px;">SMS Service Status</h2>
          <button id="toggleButton" style="padding: 12px 25px; font-weight:700; border:none; border-radius:8px; cursor:pointer;">Loading...</button>
        </div>

        <div style="flex-grow:1; max-width: 400px;">
          <h2 style="margin-bottom:8px;">Filter Logs</h2>
          <div style="display:flex; gap:8px;">
            <input type="text" id="filterInput" placeholder="Filter by IP, Number, or Message" style="flex-grow:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:#2c2c2c; color: var(--text-color);" />
            <button id="filterButton" style="background-color: var(--primary-color); color:#fff; border:none; border-radius:8px; padding:8px 15px; cursor:pointer;">Filter</button>
            <button id="clearFilterButton" style="background-color: #555; color:#fff; border:none; border-radius:8px; padding:8px 15px; cursor:pointer;">Clear</button>
          </div>
        </div>
      </div>
      <div class="card logs-section" style="margin-top: 20px;">
        <h2>SMS Logs</h2>
        <div class="table-responsive" style="overflow-x:auto; border-radius:8px;">
          <table style="width:100%; border-collapse: separate; border-spacing:0; font-size:0.95rem;">
            <thead style="background-color:#2c2c2c;">
              <tr>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">IP Address</th>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">Number</th>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">Message</th>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">Timestamp</th>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">Type</th>
                <th style="padding:15px; text-align:left; color: var(--primary-color); font-weight:700; text-transform: uppercase;">Action</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <tr>
                <td colspan="6" style="text-align:center; color: var(--text-muted); padding: 20px;">No logs to display.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <!-- Full Message Modal -->
  <div id="messageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.75); justify-content:center; align-items:center; z-index:1000;">
    <div style="background: var(--card-bg); color: var(--text-color); padding: 20px 25px; max-width: 500px; width: 90%; border-radius: 10px; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.7);">
      <button id="modalCloseBtn" aria-label="Close full message" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.5rem; color: var(--danger); cursor:pointer;">&times;</button>
      <h3 style="margin-bottom:15px;">Full Message</h3>
      <pre id="modalMessage" style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; font-family: monospace;"></pre>
    </div>
  </div>

  <script>
    // Variables
    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginButton = document.getElementById('loginButton');
    const toggleButton = document.getElementById('toggleButton');
    const logsTableBody = document.getElementById('logsTableBody');
    const loginMessage = document.getElementById('loginMessage');
    const filterInput = document.getElementById('filterInput');
    const filterButton = document.getElementById('filterButton');
    const clearFilterButton = document.getElementById('clearFilterButton');
    const messageModal = document.getElementById('messageModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalMessage = document.getElementById('modalMessage');

    let isLoggedIn = false;
    let allLogs = [];
    let blockedIps = new Set();

    // Modal open/close
    function openMessageModal(message) {
      modalMessage.textContent = message;
      messageModal.style.display = 'flex';
      modalCloseBtn.focus();
    }
    function closeMessageModal() {
      messageModal.style.display = 'none';
    }
    modalCloseBtn.addEventListener('click', closeMessageModal);
    window.addEventListener('click', (e) => {
      if (e.target === messageModal) closeMessageModal();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && messageModal.style.display === 'flex') closeMessageModal();
    });

    // Update SMS service status
    async function updateStatus() {
      try {
        const res = await fetch('/api/admin/status');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (data.success) {
          toggleButton.innerText = data.status ? 'Service ON' : 'Service OFF';
          toggleButton.classList.toggle('on', data.status);
          toggleButton.classList.toggle('off', !data.status);
        } else {
          toggleButton.innerText = 'Error';
        }
      } catch (error) {
        console.error('Status fetch failed:', error);
        toggleButton.innerText = 'Error';
      }
    }

    // Fetch blocked IPs from backend
    async function fetchBlockedIps() {
      try {
        const res = await fetch('/api/admin/blocked-ips');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (data.success && Array.isArray(data.blockedIps)) {
          blockedIps = new Set(data.blockedIps);
        } else {
          blockedIps = new Set();
        }
      } catch (error) {
        console.error('Blocked IPs fetch failed:', error);
        blockedIps = new Set();
      }
    }
      // Render logs with block/unblock buttons and full message view
    function renderLogs(logs) {
      logsTableBody.innerHTML = '';
      if (!logs.length) {
        logsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--text-muted); padding:20px;">No SMS logs found.</td></tr>`;
        return;
      }

      logs.forEach((log, idx) => {
        const isBlocked = blockedIps.has(log.ip);
        const truncated = log.message.length > 30 ? log.message.substring(0,30) + '...' : log.message;

        const tr = document.createElement('tr');
        if (isBlocked) {
          tr.style.backgroundColor = 'var(--blocked-row-bg)';
        }
        tr.innerHTML = `
          <td>${log.ip}</td>
          <td>${log.mobile}</td>
          <td><button class="view-message-btn" data-index="${idx}" style="background:none; border:none; color: var(--primary-color); cursor:pointer; text-align:left;">${truncated}</button></td>
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.type}</td>
          <td>
            ${
              isBlocked
                ? `<button class="btn-unblock" data-ip="${log.ip}" style="background:#28a745; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">Unblock IP</button>`
                : `<button class="btn-block" data-ip="${log.ip}" style="background:#dc3545; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">Block IP</button>`
            }
          </td>
        `;
        logsTableBody.appendChild(tr);
      });

      // Add event listeners for view message buttons
      document.querySelectorAll('.view-message-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const idx = parseInt(e.target.getAttribute('data-index'));
          if (!isNaN(idx) && allLogs[idx]) {
            openMessageModal(allLogs[idx].message);
          }
        });
      });

      // Add event listeners for block/unblock buttons
      document.querySelectorAll('.btn-block').forEach(btn => {
        btn.addEventListener('click', async e => {
          const ip = e.target.getAttribute('data-ip');
          if (ip && confirm(`Block IP ${ip}?`)) {
            await blockIp(ip);
            await refreshData();
          }
        });
      });

      document.querySelectorAll('.btn-unblock').forEach(btn => {
        btn.addEventListener('click', async e => {
          const ip = e.target.getAttribute('data-ip');
          if (ip && confirm(`Unblock IP ${ip}?`)) {
            await unblockIp(ip);
            await refreshData();
          }
        });
      });
    }

    // Fetch logs from backend
    async function fetchLogs() {
      try {
        const res = await fetch('/api/admin/logs');
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (data.success && Array.isArray(data.logs)) {
          allLogs = data.logs;
          applyFilter();
        } else {
          allLogs = [];
          renderLogs([]);
        }
      } catch (error) {
        console.error('Logs fetch failed:', error);
        logsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--danger); padding:20px;">Failed to load logs.</td></tr>`;
      }
    }

    // Block IP request
    async function blockIp(ip) {
      try {
        const res = await fetch('/api/admin/block-ip', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip }),
        });
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to block IP');
      } catch (error) {
        alert('Error blocking IP: ' + error.message);
      }
    }

    // Unblock IP request
    async function unblockIp(ip) {
      try {
        const res = await fetch('/api/admin/unblock-ip', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip }),
        });
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to unblock IP');
      } catch (error) {
        alert('Error unblocking IP: ' + error.message);
      }
    }

    // Apply filter to logs
    function applyFilter() {
      const filterText = filterInput.value.trim().toLowerCase();
      if (!filterText) {
        renderLogs(allLogs);
        return;
      }
      const filtered = allLogs.filter(log => {
        return (
          log.ip.toLowerCase().includes(filterText) ||
          log.mobile.toLowerCase().includes(filterText) ||
          log.message.toLowerCase().includes(filterText)
        );
      });
      renderLogs(filtered);
    }

    filterButton.addEventListener('click', applyFilter);
    clearFilterButton.addEventListener('click', () => {
      filterInput.value = '';
      applyFilter();
    });

    // Refresh all data: logs + blocked IPs + status
    async function refreshData() {
      await fetchBlockedIps();
      await fetchLogs();
      await updateStatus();
    }

    // Handle admin login
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      loginButton.disabled = true;
      loginButton.textContent = 'Logging in...';
      loginMessage.textContent = '';

      try {
        const res = await fetch('/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (data.success) {
          isLoggedIn = true;
          loginSection.classList.add('hidden');
          adminSection.classList.remove('hidden');
          await refreshData();
        } else {
          loginMessage.textContent = data.message || 'Invalid credentials. Please try again.';
        }
      } catch (error) {
        loginMessage.textContent = 'An error occurred. Please check your connection.';
        console.error('Login error:', error);
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = 'Login';
      }
    }

    // Toggle SMS service status
    toggleButton.addEventListener('click', async () => {
      if (!isLoggedIn) return;
      toggleButton.disabled = true;
      toggleButton.textContent = 'Toggling...';
      try {
        const res = await fetch('/api/admin/toggle-sms', { method: 'POST' });
        if (!res.ok) throw new Error(`HTTP status ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to toggle service');
        await updateStatus();
      } catch (error) {
        alert('Failed to toggle SMS service: ' + error.message);
      } finally {
        toggleButton.disabled = false;
      }
    });

    // On page load, check session and refresh
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/admin/session-check');
        if (res.ok) {
          const data = await res.json();
          if (data.isLoggedIn) {
            isLoggedIn = true;
            loginSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            await refreshData();
          }
        }
      } catch (error) {
        console.error('Session check failed:', error);
      }
    });
  </script>
  </body>
</html>
